<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…Ø¯ÛŒØ±ÛŒØª Ù‡ÙˆØ´Ù…Ù†Ø¯ ÙØ±ÙˆØ´Ú¯Ø§Ù‡ v4</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Vazirmatn:wght@100;400;700;900&display=swap');
        * { font-family: 'Vazirmatn', sans-serif !important; }
        body { background-color: #f8fafc; color: #1e293b; }

        .modal { 
            display: none; 
            position: fixed; 
            top: 0; left: 0; 
            width: 100%; height: 100%; 
            background: rgba(15, 23, 42, 0.6); 
            backdrop-filter: blur(4px); 
            z-index: 50; 
            align-items: center; 
            justify-content: center;
            padding: 1rem;
        }

        .input-field { width: 100%; padding: 0.75rem; border-radius: 0.5rem; border: 1px solid #cbd5e1; background-color: #ffffff; transition: all 0.2s; direction: ltr; text-align: right; }
        .input-field:focus { outline: none; border-color: #3b82f6; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.15); }
        .card { background: white; padding: 1.5rem; border-radius: 1rem; border: 1px solid #e2e8f0; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        
        .dp-calendar { display: none; position: absolute; background: white; border: 1px solid #e2e8f0; border-radius: 12px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); z-index: 100; padding: 10px; width: 280px; }
        .dp-grid { display: grid; grid-template-columns: repeat(7, 1fr); text-align: center; gap: 2px; }
        .dp-day { padding: 8px; cursor: pointer; border-radius: 6px; font-size: 13px; }
        .dp-day:hover { background: #eff6ff; }
        .dp-day.selected { background: #3b82f6; color: white; }
        
        .amount-word { font-size: 11px; color: #64748b; margin-top: 4px; display: block; font-weight: 500; }
        
        #payment-side-panel {
            display: none;
            width: 350px;
            background: #f1f5f9;
            border: 1px solid #e2e8f0;
            border-left: none;
            border-top-right-radius: 1.5rem;
            border-bottom-right-radius: 1.5rem;
            padding: 2rem;
            animation: slideIn 0.2s ease-out;
        }

        .main-form-panel {
            background: white;
            flex: 1;
            padding: 2rem;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            transition: all 0.3s ease;
        }

        .rounded-dynamic { border-radius: 1.5rem; }
        .rounded-dynamic-open { border-top-right-radius: 0; border-bottom-right-radius: 0; border-top-left-radius: 1.5rem; border-bottom-left-radius: 1.5rem; }

        @keyframes slideIn { from { transform: translateX(-10px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        
        @media (max-width: 768px) {
            #main-modal-container { flex-direction: column; }
            #payment-side-panel { width: 100%; border-radius: 1.5rem 1.5rem 0 0; border: 1px solid #e2e8f0; border-left: 1px solid #e2e8f0; }
            .rounded-dynamic-open { border-radius: 0 0 1.5rem 1.5rem; }
        }

        /* Lock Screen Style */
        #lock-screen {
            position: fixed; top:0; left:0; width:100%; height:100%;
            background: #1e293b; z-index: 1000; display: flex;
            align-items: center; justify-content: center;
        }
    </style>
</head>
<body class="p-4 md:p-8 text-right">

    <div id="lock-screen">
        <div class="bg-white p-8 rounded-2xl shadow-2xl w-80 text-center">
            <h2 class="text-xl font-bold mb-4">ÙˆØ±ÙˆØ¯ Ø¨Ù‡ Ø³ÛŒØ³ØªÙ…</h2>
            <input type="password" id="app-pass-input" placeholder="Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯" class="input-field mb-4 !text-center" style="direction: ltr;">
            <button onclick="checkPassword()" class="w-full bg-blue-600 text-white py-2 rounded-lg font-bold">ÙˆØ±ÙˆØ¯</button>
        </div>
    </div>

    <div class="max-w-6xl mx-auto" id="main-content" style="display:none;">
        <header class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 gap-4">
            <div>
                <h1 class="text-2xl font-black text-slate-900">Ù¾Ù†Ù„ Ù…Ø¯ÛŒØ±ÛŒØª Ù‡ÙˆØ´Ù…Ù†Ø¯ ÙØ±ÙˆØ´Ú¯Ø§Ù‡</h1>
                <p class="text-slate-500 text-sm">Ø­Ø³Ø§Ø¨Ø¯Ø§Ø±ÛŒ Ø¯Ù‚ÛŒÙ‚ Ø¨Ø§ ØªÙÚ©ÛŒÚ© Ø·Ù„Ø¨ Ùˆ Ø¨Ø¯Ù‡ÛŒ</p>
            </div>
            <div class="flex flex-wrap gap-2">
                <button onclick="logout()" class="bg-slate-200 text-slate-700 px-4 py-2 rounded-lg font-bold text-sm transition hover:bg-rose-500 hover:text-white">Ù‚ÙÙ„ Ú©Ø±Ø¯Ù†</button>
                <button onclick="exportToExcel()" class="bg-emerald-600 text-white px-4 py-2 rounded-lg font-bold text-sm transition hover:bg-emerald-700">Ø®Ø±ÙˆØ¬ÛŒ Ø§Ú©Ø³Ù„ (CSV)</button>
                <button onclick="document.getElementById('import-excel').click()" class="bg-amber-600 text-white px-4 py-2 rounded-lg font-bold text-sm transition hover:bg-amber-700">ÙˆØ±ÙˆØ¯ Ø¯Ø§Ø¯Ù‡ (CSV)</button>
                <input type="file" id="import-excel" hidden accept=".csv" onchange="importFromExcel(event)">
                <button onclick="openTransactionModal()" class="bg-blue-600 text-white px-6 py-2 rounded-lg font-bold shadow-lg transition hover:bg-blue-700">Ø«Ø¨Øª ØªØ±Ø§Ú©Ù†Ø´ Ø¬Ø¯ÛŒØ¯</button>
            </div>
        </header>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
            <div class="card border-r-4 border-r-blue-500">
                <p class="text-slate-400 text-xs mb-1">Ú©Ù„ Ø·Ù„Ø¨ (Ø§Ø² Ù…Ø´ØªØ±ÛŒ)</p>
                <h2 id="total-customer-balance" class="text-xl font-black text-blue-600">Û° Ø±ÛŒØ§Ù„</h2>
            </div>
            <div class="card border-r-4 border-r-rose-500">
                <p class="text-slate-400 text-xs mb-1">Ú©Ù„ Ø¨Ø¯Ù‡ÛŒ (Ø¨Ù‡ ØªØ£Ù…ÛŒÙ†â€ŒÚ©Ù†Ù†Ø¯Ù‡)</p>
                <h2 id="total-shop-debt" class="text-xl font-black text-rose-600">Û° Ø±ÛŒØ§Ù„</h2>
            </div>
            <div class="card border-r-4 border-r-slate-500">
                <p class="text-slate-400 text-xs mb-1">ØªØ±Ø§Ú©Ù†Ø´ Ù‡Ø§</p>
                <h2 id="tx-count" class="text-xl font-black text-slate-700">Û°</h2>
            </div>
        </div>

        <div class="card !p-0 overflow-hidden shadow-xl border-none">
            <div class="p-4 bg-slate-50 border-b flex flex-wrap gap-4 items-center">
                <div class="flex-1 min-w-[200px]">
                    <input type="text" id="search-input" oninput="renderTable()" 
                           placeholder="Ø¬Ø³ØªØ¬Ùˆ Ø¯Ø± Ù†Ø§Ù…ØŒ Ù…ÙˆØ¨Ø§ÛŒÙ„ ÛŒØ§ ØªÙˆØ¶ÛŒØ­Ø§Øª..." 
                           class="input-field !text-right !bg-white">
                </div>
                <div class="flex items-center gap-2">
                    <span class="text-xs font-bold text-slate-500">Ø§Ø²:</span>
                    <input type="text" id="date-from" readonly onclick="showDP(this)" 
                           placeholder="----/--/--" class="input-field !w-32 !text-center !bg-white cursor-pointer">
                    <span class="text-xs font-bold text-slate-500">ØªØ§:</span>
                    <input type="text" id="date-to" readonly onclick="showDP(this)" 
                           placeholder="----/--/--" class="input-field !w-32 !text-center !bg-white cursor-pointer">
                    <button onclick="clearDateFilter()" class="text-rose-500 text-xs font-bold">Ø­Ø°Ù ØªØ§Ø±ÛŒØ®</button>
                </div>
                <div class="w-40">
                    <select id="filter-type" onchange="renderTable()" class="input-field !text-right !bg-white">
                        <option value="all">Ù‡Ù…Ù‡ Ø§Ø´Ø®Ø§Øµ</option>
                        <option value="customer">Ù…Ø´ØªØ±ÛŒØ§Ù†</option>
                        <option value="supplier">ØªØ£Ù…ÛŒÙ†â€ŒÚ©Ù†Ù†Ø¯Ú¯Ø§Ù†</option>
                    </select>
                </div>
            </div>

            <div class="overflow-x-auto">
                <table class="w-full text-right border-collapse">
                    <thead class="bg-slate-800 text-white">
                        <tr>
                            <th class="p-4 text-xs font-medium">ØªØ§Ø±ÛŒØ®</th>
                            <th class="p-4 text-xs font-medium">Ø·Ø±Ù Ø­Ø³Ø§Ø¨</th>
                            <th class="p-4 text-xs font-medium">Ù…Ø¨Ù„Øº Ú©Ù„</th>
                            <th class="p-4 text-xs font-medium">Ù¾Ø±Ø¯Ø§Ø®ØªÛŒ</th>
                            <th class="p-4 text-xs font-medium">Ù…Ø§Ù†Ø¯Ù‡</th>
                            <th class="p-4 text-xs font-medium text-center">Ø¹Ù…Ù„ÛŒØ§Øª</th>
                        </tr>
                    </thead>
                    <tbody id="ledger-body" class="divide-y divide-slate-100 bg-white"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="transaction-modal" class="modal">
        <div id="main-modal-container" class="flex flex-row max-w-5xl w-full justify-center">
            <div id="payment-side-panel">
                <h4 class="font-black text-slate-700 mb-6 border-b pb-2">Ø¬Ø²Ø¦ÛŒØ§Øª Ù¾Ø±Ø¯Ø§Ø®Øª</h4>
                <div id="side-card" class="space-y-4 hidden">
                    <input type="text" id="card-src-bank" placeholder="Ø¨Ø§Ù†Ú© Ù…Ø¨Ø¯Ø£" class="input-field">
                    <input type="text" id="card-src-num" placeholder="Ø´Ù…Ø§Ø±Ù‡ Ú©Ø§Ø±Øª Ù…Ø¨Ø¯Ø£" class="input-field !text-center">
                    <input type="text" id="card-dest-bank" placeholder="Ø¨Ø§Ù†Ú© Ù…Ù‚ØµØ¯" class="input-field">
                    <input type="text" id="card-dest-num" placeholder="Ø´Ù…Ø§Ø±Ù‡ Ù…Ù‚ØµØ¯" class="input-field !text-center">
                </div>
                <div id="side-check" class="space-y-4 hidden">
                    <input type="text" id="check-num" placeholder="Ø´Ù…Ø§Ø±Ù‡ Ú†Ú©" class="input-field !text-center">
                    <input type="text" id="check-bank" placeholder="Ø¨Ø§Ù†Ú© ØµØ§Ø¯Ø±Ú©Ù†Ù†Ø¯Ù‡" class="input-field">
                    <input type="text" id="check-date" readonly onclick="showDP(this)" placeholder="ØªØ§Ø±ÛŒØ® Ø³Ø±Ø±Ø³ÛŒØ¯" class="input-field bg-white cursor-pointer !text-center">
                    <input type="text" id="check-owner" placeholder="Ù†Ø§Ù… ØµØ§Ø­Ø¨ Ú†Ú©" class="input-field">
                </div>
                <div id="side-pos" class="space-y-4 hidden">
                    <input type="text" id="pos-terminal" placeholder="Ø´Ù…Ø§Ø±Ù‡ ØªØ±Ù…ÛŒÙ†Ø§Ù„" class="input-field !text-center">
                    <input type="text" id="pos-rrn" placeholder="Ø´Ù…Ø§Ø±Ù‡ Ù¾ÛŒÚ¯ÛŒØ±ÛŒ (RRN)" class="input-field !text-center">
                </div>
            </div>

            <div id="main-form-box" class="main-form-panel rounded-dynamic max-w-xl w-full">
                <h3 id="modal-title" class="text-2xl font-black mb-8 text-slate-800">Ø«Ø¨Øª ØªØ±Ø§Ú©Ù†Ø´</h3>
                <form id="transaction-form" onsubmit="saveTransaction(event)" class="space-y-4">
                    <input type="hidden" id="edit-id">
                    <div id="quick-pay-section" class="hidden bg-emerald-50 p-4 rounded-xl border border-emerald-100 mb-4">
                        <p class="text-xs font-bold text-emerald-700 mb-2">Ø«Ø¨Øª Ù…Ø¨Ù„Øº Ø¯Ø±ÛŒØ§ÙØªÛŒ Ø¬Ø¯ÛŒØ¯:</p>
                        <input type="text" id="new-pay-display" class="input-field font-bold !text-left" placeholder="Ù…Ø¨Ù„Øº Ø¯Ø±ÛŒØ§ÙØªÛŒ Ø¬Ø¯ÛŒØ¯" oninput="handleInput(this, 'new-pay-val', 'new-pay-w')">
                        <input type="hidden" id="new-pay-val" value="0">
                        <span id="new-pay-w" class="amount-word"></span>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <input type="text" id="party-name" placeholder="Ù†Ø§Ù… Ø·Ø±Ù Ø­Ø³Ø§Ø¨" required class="input-field !text-right">
                        <input type="text" id="party-mobile" placeholder="Ø´Ù…Ø§Ø±Ù‡ Ù…ÙˆØ¨Ø§ÛŒÙ„" required class="input-field !text-center">
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <select id="party-type" class="input-field !text-right">
                            <option value="customer">Ù…Ø´ØªØ±ÛŒ (Ø·Ù„Ø¨ Ù…Ø§)</option>
                            <option value="supplier">ØªØ§Ù…ÛŒÙ†â€ŒÚ©Ù†Ù†Ø¯Ù‡ (Ø¨Ø¯Ù‡ÛŒ Ù…Ø§)</option>
                        </select>
                        <input type="text" id="transaction-date" readonly onclick="showDP(this)" required class="input-field bg-slate-50 cursor-pointer !text-center">
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4" id="main-amount-row">
                        <div>
                            <input type="text" id="total-display" class="input-field font-bold !text-left" placeholder="Ù…Ø¨Ù„Øº Ú©Ù„" oninput="handleInput(this, 'total-val', 'total-w')">
                            <input type="hidden" id="total-val">
                            <span id="total-w" class="amount-word"></span>
                        </div>
                        <div>
                            <input type="text" id="paid-display" class="input-field font-bold text-emerald-600 !text-left" placeholder="Ù…Ø¨Ù„Øº Ù¾Ø±Ø¯Ø§Ø®ØªÛŒ" oninput="handleInput(this, 'paid-val', 'paid-w')">
                            <input type="hidden" id="paid-val">
                            <span id="paid-w" class="amount-word"></span>
                        </div>
                    </div>
                    <div>
                        <textarea id="description" placeholder="ØªÙˆØ¶ÛŒØ­Ø§Øª (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)..." class="input-field !text-right h-20 resize-none"></textarea>
                    </div>
                    <div>
                        <select id="pay-method" class="input-field !text-right" onchange="syncSidePanel()">
                            <option value="none">Ø«Ø¨Øª Ø¯Ø± Ø¯ÙØªØ± (Ø¨Ø¯ÙˆÙ† Ø¬Ø²Ø¦ÛŒØ§Øª Ø¨Ø§Ù†Ú©ÛŒ)</option>
                            <option value="card">Ú©Ø§Ø±Øª Ø¨Ù‡ Ú©Ø§Ø±Øª</option>
                            <option value="check">Ú†Ú©</option>
                            <option value="pos">Ú©Ø§Ø±ØªØ®ÙˆØ§Ù†</option>
                        </select>
                    </div>
                    <div class="bg-blue-50 p-4 rounded-2xl flex justify-between items-center border border-blue-100 mt-4">
                        <div>
                            <span class="text-xs text-blue-500 font-bold block">Ù…Ø§Ù†Ø¯Ù‡ Ù†Ù‡Ø§ÛŒÛŒ:</span>
                            <span id="calc-res" class="font-black text-xl text-blue-700">Û° Ø±ÛŒØ§Ù„</span>
                        </div>
                        <button type="submit" class="bg-blue-600 text-white px-8 py-3 rounded-xl font-bold hover:bg-blue-700 transition">ØªØ§ÛŒÛŒØ¯ Ùˆ Ø«Ø¨Øª</button>
                    </div>
                    <button type="button" onclick="closeModal('transaction-modal')" class="w-full text-slate-400 text-sm">Ø§Ù†ØµØ±Ø§Ù Ùˆ Ø¨Ø³ØªÙ†</button>
                </form>
            </div>
        </div>
    </div>

    <div id="datepicker-element" class="dp-calendar">
        <div class="flex justify-between items-center p-2 mb-2 border-b">
            <button onclick="changeMonth(-1)" class="text-xs bg-slate-100 px-2 py-1 rounded">Ù‚Ø¨Ù„ÛŒ</button>
            <span id="dp-month-year" class="text-xs font-bold"></span>
            <button onclick="changeMonth(1)" class="text-xs bg-slate-100 px-2 py-1 rounded">Ø¨Ø¹Ø¯ÛŒ</button>
        </div>
        <div id="dp-days" class="dp-grid"></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/jalali-moment/dist/jalali-moment.browser.js"></script>

    <script>
        // --- ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø§Ù…Ù†ÛŒØªÛŒ ---
        const APP_PASSWORD = "AmirAhmadi1404@!"; // Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ø®ÙˆØ¯ Ø±Ø§ Ø§ÛŒÙ†Ø¬Ø§ ØªØºÛŒÛŒØ± Ø¯Ù‡ÛŒØ¯

        function checkPassword() {
            const input = document.getElementById('app-pass-input').value;
            if (input === APP_PASSWORD) {
                sessionStorage.setItem('isLoggedIn', 'true');
                document.getElementById('lock-screen').style.display = 'none';
                document.getElementById('main-content').style.display = 'block';
            } else {
                alert('Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ø§Ø´ØªØ¨Ø§Ù‡ Ø§Ø³Øª!');
            }
        }

        function logout() {
            sessionStorage.removeItem('isLoggedIn');
            location.reload();
        }

        window.addEventListener('DOMContentLoaded', () => {
            if (sessionStorage.getItem('isLoggedIn') === 'true') {
                document.getElementById('lock-screen').style.display = 'none';
                document.getElementById('main-content').style.display = 'block';
            }
        });

        // --- Ù…Ù†Ø·Ù‚ Ø¨Ø±Ù†Ø§Ù…Ù‡ ---
        let db;
        let transactions = [];
        let activeInput = null;
        let viewDate = moment();

        function initDB() {
            const req = indexedDB.open("StoreMasterDB_v5", 1);
            req.onupgradeneeded = (e) => {
                db = e.target.result;
                if (!db.objectStoreNames.contains("tx")) {
                    db.createObjectStore("tx", { keyPath: "id", autoIncrement: true });
                }
            };
            req.onsuccess = (e) => { db = e.target.result; loadData(); };
        }

        function loadData() {
            db.transaction("tx").objectStore("tx").getAll().onsuccess = (e) => {
                transactions = e.target.result;
                renderTable();
            };
        }

        function renderTable() {
            const body = document.getElementById('ledger-body');
            const searchTerm = document.getElementById('search-input')?.value.toLowerCase() || '';
            const typeFilter = document.getElementById('filter-type')?.value || 'all';
            const statusFilter = document.getElementById('filter-status')?.value || 'all';
            const dateFrom = document.getElementById('date-from')?.value || '';
            const dateTo = document.getElementById('date-to')?.value || '';

            body.innerHTML = '';
            let tC = 0, tS = 0;

            const filtered = transactions.filter(t => {
                const matchesSearch = t.partyName.toLowerCase().includes(searchTerm) || 
                                     t.partyMobile.includes(searchTerm) || 
                                     (t.desc && t.desc.toLowerCase().includes(searchTerm));
                const matchesType = typeFilter === 'all' || t.partyType === typeFilter;
                const bal = t.total - t.paid;
                const matchesStatus = statusFilter === 'all' || (statusFilter === 'debt' && bal > 0) || (statusFilter === 'settled' && bal <= 0);
                const matchesDate = (!dateFrom || t.date >= dateFrom) && (!dateTo || t.date <= dateTo);
                return matchesSearch && matchesType && matchesStatus && matchesDate;
            });

            filtered.sort((a, b) => {
                const dateCompare = b.date.localeCompare(a.date);
                return dateCompare !== 0 ? dateCompare : b.ts - a.ts;
            }).forEach(t => {
                const bal = t.total - t.paid;
                if (t.partyType === 'customer') tC += bal; else tS += bal;
                
                body.innerHTML += `
                    <tr class="hover:bg-slate-50 transition-colors">
                        <td class="p-4 text-xs font-bold text-slate-500">${t.date}</td>
                        <td class="p-4">
                            <b class="text-slate-900">${t.partyName}</b><br>
                            <small class="text-slate-400">${t.partyMobile}</small>
                            ${t.desc ? `<br><small class="text-blue-500 italic">ğŸ“ ${t.desc}</small>` : ''}
                        </td>
                        <td class="p-4 font-medium">${new Intl.NumberFormat().format(t.total)}</td>
                        <td class="p-4 text-emerald-600 font-bold">${new Intl.NumberFormat().format(t.paid)}</td>
                        <td class="p-4 font-black ${bal > 0 ? 'text-rose-600' : 'text-slate-300'}">${bal > 0 ? new Intl.NumberFormat().format(bal) : 'ØªØ³ÙˆÛŒÙ‡'}</td>
                        <td class="p-4 text-center">
                            <div class="flex flex-wrap gap-1 justify-center">
                                <button onclick="openQuickPay(${t.id})" class="bg-emerald-600 text-white px-3 py-1 rounded-lg text-xs font-bold hover:bg-emerald-700 transition">Ø«Ø¨Øª Ø¯Ø±ÛŒØ§ÙØªÛŒ</button>
                                <button onclick="editTx(${t.id})" class="bg-blue-50 text-blue-700 px-3 py-1 rounded-lg text-xs font-bold hover:bg-blue-600 hover:text-white transition">ÙˆÛŒØ±Ø§ÛŒØ´</button>
                                <button onclick="newCostumerFactor(${t.id})" class="bg-slate-50 text-slate-700 px-3 py-1 rounded-lg text-xs font-bold hover:bg-slate-200 transition">ÙØ§Ú©ØªÙˆØ± Ø¬Ø¯ÛŒØ¯</button>
                                <button onclick="deleteTx(${t.id})" class="text-rose-400 hover:text-rose-600 px-2 transition text-lg">Ã—</button>
                            </div>
                        </td>
                    </tr>`;
            });

            document.getElementById('total-customer-balance').innerText = new Intl.NumberFormat().format(tC) + " Ø±ÛŒØ§Ù„";
            document.getElementById('total-shop-debt').innerText = new Intl.NumberFormat().format(tS) + " Ø±ÛŒØ§Ù„";
            document.getElementById('tx-count').innerText = filtered.length;
        }

        function exportToExcel() {
            if (transactions.length === 0) return alert("Ø¯Ø§Ø¯Ù‡â€ŒØ§ÛŒ Ù†ÛŒØ³Øª.");
            let csv = "\uFEFFØªØ§Ø±ÛŒØ®,Ù†Ø§Ù… Ø·Ø±Ù Ø­Ø³Ø§Ø¨,Ù…ÙˆØ¨Ø§ÛŒÙ„,ØªÙˆØ¶ÛŒØ­Ø§Øª,Ù†ÙˆØ¹,Ù…Ø¨Ù„Øº Ú©Ù„,Ù¾Ø±Ø¯Ø§Ø®ØªÛŒ,Ø±ÙˆØ´,Ø¨Ø§Ù†Ú© Ù…Ø¨Ø¯Ø§,Ú©Ø§Ø±Øª Ù…Ø¨Ø¯Ø§,Ø¨Ø§Ù†Ú© Ù…Ù‚ØµØ¯,Ú©Ø§Ø±Øª Ù…Ù‚ØµØ¯,Ø´Ù…Ø§Ø±Ù‡ Ú†Ú©,Ø¨Ø§Ù†Ú© Ú†Ú©,ØªØ§Ø±ÛŒØ® Ú†Ú©,ØµØ§Ø­Ø¨ Ú†Ú©,ØªØ±Ù…ÛŒÙ†Ø§Ù„ Ù¾ÙˆØ²,Ù¾ÛŒÚ¯ÛŒØ±ÛŒ Ù¾ÙˆØ²\n";
            transactions.forEach(t => {
                let b = t.bankInfo || {};
                csv += [t.date, t.partyName, t.partyMobile, t.desc || '', t.partyType, t.total, t.paid, t.method,
                        b.cardSrcB, b.cardSrcN, b.cardDstB, b.cardDstN, b.checkN, b.checkB, b.checkD, b.checkO, b.posT, b.posR]
                        .map(v => `"${v || ''}"`).join(",") + "\n";
            });
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = `Report_${moment().format('jYYYY-jMM-jDD')}.csv`;
            link.click();
        }

        function importFromExcel(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                const lines = e.target.result.split("\n");
                const store = db.transaction("tx", "readwrite").objectStore("tx");
                for (let i = 1; i < lines.length; i++) {
                    const cols = lines[i].split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/).map(v => v.replace(/"/g, '').trim());
                    if (cols.length < 7) continue;
                    store.add({
                        date: cols[0], partyName: cols[1], partyMobile: cols[2], desc: cols[3], partyType: cols[4],
                        total: parseInt(cols[5]) || 0, paid: parseInt(cols[6]) || 0, method: cols[7],
                        bankInfo: { cardSrcB: cols[8], cardSrcN: cols[9], cardDstB: cols[10], cardDstN: cols[11],
                                    checkN: cols[12], checkB: cols[13], checkD: cols[14], checkO: cols[15],
                                    posT: cols[16], posR: cols[17] },
                        ts: Date.now() + i
                    });
                }
                setTimeout(() => { loadData(); alert("ÙˆØ§Ø±Ø¯ Ø´Ø¯."); }, 500);
            };
            reader.readAsText(file);
        }

        function saveTransaction(e) {
            e.preventDefault();
            const id = document.getElementById('edit-id').value;
            const newPay = parseInt(document.getElementById('new-pay-val').value) || 0;
            const currentPaid = parseInt(document.getElementById('paid-val').value) || 0;

            const data = {
                partyName: document.getElementById('party-name').value,
                partyMobile: document.getElementById('party-mobile').value,
                partyType: document.getElementById('party-type').value,
                date: document.getElementById('transaction-date').value,
                desc: document.getElementById('description').value,
                total: parseInt(document.getElementById('total-val').value) || 0,
                paid: currentPaid + newPay,
                method: document.getElementById('pay-method').value,
                bankInfo: {
                    cardSrcB: document.getElementById('card-src-bank').value, cardSrcN: document.getElementById('card-src-num').value,
                    cardDstB: document.getElementById('card-dest-bank').value, cardDstN: document.getElementById('card-dest-num').value,
                    checkN: document.getElementById('check-num').value, checkB: document.getElementById('check-bank').value,
                    checkD: document.getElementById('check-date').value, checkO: document.getElementById('check-owner').value,
                    posT: document.getElementById('pos-terminal').value, posR: document.getElementById('pos-rrn').value
                },
                ts: Date.now()
            };
            const store = db.transaction("tx", "readwrite").objectStore("tx");
            const req = id ? store.put({...data, id: parseInt(id)}) : store.add(data);
            req.onsuccess = () => { loadData(); closeModal('transaction-modal'); };
        }

        function handleInput(inp, hid, wrd) {
            let v = inp.value.replace(/,/g, '').replace(/[Û°-Û¹]/g, d => 'Û°Û±Û²Û³Û´ÛµÛ¶Û·Û¸Û¹'.indexOf(d)).replace(/[^\d]/g, '');
            let n = parseInt(v) || 0;
            inp.value = n ? new Intl.NumberFormat().format(n) : "";
            document.getElementById(hid).value = n;
            document.getElementById(wrd).innerText = n ? new Intl.NumberFormat().format(Math.floor(n/10)) + " ØªÙˆÙ…Ø§Ù†" : "";
            updateFinalBalance();
        }

        function updateFinalBalance() {
            const total = parseInt(document.getElementById('total-val').value) || 0;
            const paid = parseInt(document.getElementById('paid-val').value) || 0;
            const newPay = parseInt(document.getElementById('new-pay-val').value) || 0;
            const balance = total - (paid + newPay);
            const resEl = document.getElementById('calc-res');
            resEl.innerText = new Intl.NumberFormat().format(balance) + " Ø±ÛŒØ§Ù„";
            resEl.className = balance > 0 ? "font-black text-xl text-rose-600" : "font-black text-xl text-emerald-600";
        }

        function syncSidePanel() {
            const method = document.getElementById('pay-method').value;
            const panel = document.getElementById('payment-side-panel');
            const mainBox = document.getElementById('main-form-box');
            panel.style.display = method === 'none' ? 'none' : 'block';
            mainBox.className = method === 'none' ? "main-form-panel rounded-dynamic max-w-xl w-full" : "main-form-panel rounded-dynamic-open max-w-xl w-full";
            ['card','check','pos'].forEach(m => document.getElementById('side-'+m).classList.add('hidden'));
            if(method !== 'none') document.getElementById('side-' + method).classList.remove('hidden');
        }

        function openQuickPay(id) {
            const t = transactions.find(x => x.id === id);
            openTransactionModal();
            document.getElementById('modal-title').innerText = "Ø«Ø¨Øª Ø¯Ø±ÛŒØ§ÙØªÛŒ Ø¬Ø¯ÛŒØ¯";
            document.getElementById('edit-id').value = t.id;
            document.getElementById('party-name').value = t.partyName;
            document.getElementById('party-mobile').value = t.partyMobile;
            document.getElementById('party-type').value = t.partyType;
            document.getElementById('total-val').value = t.total;
            document.getElementById('paid-val').value = t.paid;
            
            document.getElementById('quick-pay-section').classList.remove('hidden');
            document.getElementById('main-amount-row').classList.add('hidden');
            document.getElementById('party-name').readOnly = true;
            document.getElementById('party-mobile').readOnly = true;
            updateFinalBalance();
        }

        function newCostumerFactor(id) {
            const t = transactions.find(x => x.id === id);
            openTransactionModal();
            document.getElementById('party-name').value = t.partyName;
            document.getElementById('party-mobile').value = t.partyMobile;
            document.getElementById('party-type').value = t.partyType;
            syncSidePanel();
        }

        function editTx(id) {
            const t = transactions.find(x => x.id === id);
            openTransactionModal();
            document.getElementById('edit-id').value = t.id;
            document.getElementById('party-name').value = t.partyName;
            document.getElementById('party-mobile').value = t.partyMobile;
            document.getElementById('party-type').value = t.partyType;
            document.getElementById('transaction-date').value = t.date;
            document.getElementById('description').value = t.desc || '';
            document.getElementById('total-val').value = t.total;
            document.getElementById('paid-val').value = t.paid;
            document.getElementById('total-display').value = new Intl.NumberFormat().format(t.total);
            document.getElementById('paid-display').value = new Intl.NumberFormat().format(t.paid);
            document.getElementById('pay-method').value = t.method || 'none';
            const b = t.bankInfo || {};
            document.getElementById('card-src-bank').value = b.cardSrcB || '';
            document.getElementById('card-src-num').value = b.cardSrcN || '';
            document.getElementById('card-dest-bank').value = b.cardDstB || '';
            document.getElementById('card-dest-num').value = b.cardDstN || '';
            document.getElementById('check-num').value = b.checkN || '';
            document.getElementById('check-bank').value = b.checkB || '';
            document.getElementById('check-date').value = b.checkD || '';
            document.getElementById('check-owner').value = b.checkO || '';
            document.getElementById('pos-terminal').value = b.posT || '';
            document.getElementById('pos-rrn').value = b.posR || '';
            syncSidePanel(); updateFinalBalance();
        }

        function openTransactionModal() {
            document.getElementById('transaction-form').reset();
            document.getElementById('modal-title').innerText = "Ø«Ø¨Øª ØªØ±Ø§Ú©Ù†Ø´";
            document.getElementById('edit-id').value = '';
            document.getElementById('total-val').value = 0;
            document.getElementById('paid-val').value = 0;
            document.getElementById('new-pay-val').value = 0;
            document.getElementById('total-w').innerText = "";
            document.getElementById('paid-w').innerText = "";
            document.getElementById('new-pay-w').innerText = "";
            document.getElementById('calc-res').innerText = "Û° Ø±ÛŒØ§Ù„";
            document.getElementById('transaction-date').value = moment().locale('fa').format('YYYY/MM/DD');
            document.getElementById('quick-pay-section').classList.add('hidden');
            document.getElementById('main-amount-row').classList.remove('hidden');
            document.getElementById('party-name').readOnly = false;
            document.getElementById('party-mobile').readOnly = false;
            syncSidePanel(); openModal('transaction-modal');
        }

        function clearDateFilter() {
            document.getElementById('date-from').value = '';
            document.getElementById('date-to').value = '';
            renderTable();
        }

        function showDP(inp) {
            activeInput = inp;
            const dp = document.getElementById('datepicker-element');
            dp.style.display = 'block';
            const r = inp.getBoundingClientRect();
            dp.style.top = (r.bottom + window.scrollY + 5) + 'px';
            dp.style.left = r.left + 'px';
            renderCalendar();
            event.stopPropagation();
        }

        function selectDate(s) { activeInput.value = s; hideDP(); renderTable(); }
        function hideDP() { document.getElementById('datepicker-element').style.display = 'none'; }
        function changeMonth(n) { viewDate.add(n, 'jMonth'); renderCalendar(); }
        function renderCalendar() {
            const m = moment(viewDate).locale('fa');
            document.getElementById('dp-month-year').innerText = m.format('jMMMM jYYYY');
            const g = document.getElementById('dp-days'); g.innerHTML = '';
            const end = m.clone().endOf('jMonth').jDate();
            const startDay = m.clone().startOf('jMonth').day();
            let skip = startDay === 6 ? 0 : startDay + 1;
            for (let i = 0; i < skip; i++) g.innerHTML += '<div></div>';
            for (let d = 1; d <= end; d++) {
                const s = m.clone().jDate(d).format('YYYY/MM/DD');
                g.innerHTML += `<div class="dp-day" onclick="selectDate('${s}')">${d}</div>`;
            }
        }

        function deleteTx(id) { if (confirm("Ø­Ø°Ù Ø´ÙˆØ¯ØŸ")) db.transaction("tx", "readwrite").objectStore("tx").delete(id).onsuccess = () => loadData(); }
        function openModal(id) { document.getElementById(id).style.display = 'flex'; }
        function closeModal(id) { document.getElementById(id).style.display = 'none'; }

        window.onclick = (e) => { if (!e.target.closest('.dp-calendar')) hideDP(); };
        window.onload = initDB;
    </script>
</body>
</html>
